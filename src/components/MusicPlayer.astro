---
import { useEffect } from 'react';
---
<div class="fixed bottom-4 right-4 z-10">
  <audio id="bgMusic" preload="auto">
    <source src="https://archive.org/download/frank-sinatra-the-very-best-of/The%20Very%20Best%20Of%20Frank%20Sinatra/1-01%20Stardust.mp3" type="audio/mp3">
  </audio>
  <button
    id="musicToggle"
    class="bg-white/10 backdrop-blur-md p-4 rounded-full shadow-xl hover:bg-white/20 transition-all duration-300 group"
    aria-label="Toggle Music"
  >
    <div class="relative">
      <svg id="playIcon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
      </svg>
      <svg id="pauseIcon" class="hidden w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 15.536L2.404 2.404M2.404 21.596L15.536 8.464"/>
      </svg>
    </div>
    <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-black/75 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
      <span id="musicStatus">Play Music</span>
    </span>
  </button>
</div>

<div id="confetti-container"></div>

<script>
  import confetti from 'canvas-confetti';

  let isPlaying = false;
  const audio = document.getElementById('bgMusic');
  const musicToggle = document.getElementById('musicToggle');
  const playIcon = document.getElementById('playIcon');
  const pauseIcon = document.getElementById('pauseIcon');
  const musicStatus = document.getElementById('musicStatus');

  function updateMusicUI() {
    if (playIcon && pauseIcon && musicStatus) {
      if (isPlaying) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        musicStatus.textContent = 'Pause Music';
      } else {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        musicStatus.textContent = 'Play Music';
      }
    }
  }

  // Hide music player when modal is open
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        const modalOverlay = document.querySelector('.ReactModal__Overlay');
        if (modalOverlay && musicToggle) {
          const isModalOpen = modalOverlay.classList.contains('ReactModal__Overlay--after-open');
          musicToggle.style.visibility = isModalOpen ? 'hidden' : 'visible';
        }
      }
    });
  });

  // Start observing modal overlay changes
  const modalRoot = document.getElementById('root');
  if (modalRoot) {
    observer.observe(modalRoot, {
      attributes: true,
      subtree: true,
      attributeFilter: ['class']
    });
  }

  // Auto-play music when user interacts with the page
  function attemptAutoPlay() {
    if (audio && !isPlaying) {
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          isPlaying = true;
          updateMusicUI();
        }).catch(error => {
          console.log("Auto-play prevented:", error);
        });
      }
    }
  }

  // Try to auto-play when user interacts with the page
  document.addEventListener('click', attemptAutoPlay, { once: true });
  document.addEventListener('touchstart', attemptAutoPlay, { once: true });

  if (musicToggle && audio) {
    musicToggle.addEventListener('click', () => {
      if (isPlaying) {
        audio.pause();
      } else {
        audio.play();
      }
      isPlaying = !isPlaying;
      updateMusicUI();
    });

    audio.addEventListener('ended', () => {
      isPlaying = false;
      updateMusicUI();
    });
  }

  // Start confetti on page load
  const duration = 5 * 1000;
  const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
  const animationEnd = Date.now() + duration;

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  const interval = setInterval(function() {
    const timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      clearInterval(interval);
      return;
    }

    const particleCount = 50 * (timeLeft / duration);

    confetti({
      ...defaults,
      particleCount,
      origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
    });
    confetti({
      ...defaults,
      particleCount,
      origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
    });
  }, 250);
</script>

<style>
  .group:hover .group-hover\:opacity-100 {
    opacity: 1;
  }
</style>